<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug StudyPal GitHub Pages</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #333; background: #2a2a2a; }
        .success { border-color: #00ff00; }
        .error { border-color: #ff0000; color: #ff6666; }
        .info { color: #66ccff; }
        button { padding: 10px; margin: 5px; background: #333; color: #00ff00; border: 1px solid #666; cursor: pointer; }
        button:hover { background: #444; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>üîç StudyPal GitHub Pages Debug Tool</h1>
    
    <div class="test">
        <h3>üìç Environment Detection</h3>
        <div id="env-info"></div>
    </div>
    
    <div class="test">
        <h3>üîß Supabase Configuration</h3>
        <div id="supabase-info"></div>
    </div>
    
    <div class="test">
        <h3>üß™ Edge Function Test</h3>
        <button onclick="testEdgeFunction()">Test Edge Function</button>
        <div id="edge-function-result"></div>
    </div>
    
    <div class="test">
        <h3>üñºÔ∏è Image Test</h3>
        <button onclick="testImageFunction()">Test Image Analysis</button>
        <div id="image-function-result"></div>
    </div>

    <script type="module">
        // Environment detection
        function displayEnvironmentInfo() {
            const envInfo = {
                hostname: window.location.hostname,
                pathname: window.location.pathname,
                protocol: window.location.protocol,
                userAgent: navigator.userAgent,
                isGitHubPages: window.location.hostname.includes('github.io'),
                timestamp: new Date().toISOString()
            };
            
            document.getElementById('env-info').innerHTML = `
                <div class="info">
                    <strong>Hostname:</strong> ${envInfo.hostname}<br>
                    <strong>Path:</strong> ${envInfo.pathname}<br>
                    <strong>Protocol:</strong> ${envInfo.protocol}<br>
                    <strong>Is GitHub Pages:</strong> ${envInfo.isGitHubPages}<br>
                    <strong>Timestamp:</strong> ${envInfo.timestamp}
                </div>
            `;
        }

        // Test Supabase configuration
        async function testSupabaseConfig() {
            try {
                // Try to import Supabase
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js');
                
                // Test with the known working configuration
                const supabaseUrl = 'https://xphgwzbxwwaqoaedfsoq.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwaGd3emJ4d3dhcW9hZWRmc29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMjU0ODgsImV4cCI6MjA2NjgwMTQ4OH0.J6lqFQjg41BsaA1i0yWeIkAR_yN2ia7_FgkTnxmdzLU';
                
                const supabase = createClient(supabaseUrl, supabaseKey);
                
                document.getElementById('supabase-info').innerHTML = `
                    <div class="success">
                        ‚úÖ Supabase client created successfully<br>
                        <strong>URL:</strong> ${supabaseUrl}<br>
                        <strong>Key:</strong> ${supabaseKey.substring(0, 50)}...<br>
                        <strong>Client:</strong> ${typeof supabase}
                    </div>
                `;
                
                return supabase;
            } catch (error) {
                document.getElementById('supabase-info').innerHTML = `
                    <div class="error">
                        ‚ùå Supabase configuration failed<br>
                        <strong>Error:</strong> ${error.message}<br>
                        <pre>${error.stack}</pre>
                    </div>
                `;
                return null;
            }
        }

        // Test Edge Function
        window.testEdgeFunction = async function() {
            document.getElementById('edge-function-result').innerHTML = '<div class="info">üîÑ Testing Edge Function...</div>';
            
            try {
                const supabase = await testSupabaseConfig();
                if (!supabase) {
                    throw new Error('Supabase client not available');
                }

                const { data, error } = await supabase.functions.invoke('chat-with-ai', {
                    body: {
                        messages: [
                            { role: 'user', content: 'Hello from GitHub Pages debug tool!' }
                        ]
                    }
                });

                if (error) {
                    throw error;
                }

                document.getElementById('edge-function-result').innerHTML = `
                    <div class="success">
                        ‚úÖ Edge Function works!<br>
                        <strong>Response:</strong> ${data.response}<br>
                        <strong>Timestamp:</strong> ${data.timestamp}
                    </div>
                `;
            } catch (error) {
                document.getElementById('edge-function-result').innerHTML = `
                    <div class="error">
                        ‚ùå Edge Function failed<br>
                        <strong>Error:</strong> ${error.message}<br>
                        <strong>Details:</strong> ${JSON.stringify(error, null, 2)}
                    </div>
                `;
            }
        };

        // Test Image Function
        window.testImageFunction = async function() {
            document.getElementById('image-function-result').innerHTML = '<div class="info">üîÑ Testing Image Function...</div>';
            
            try {
                const supabase = await testSupabaseConfig();
                if (!supabase) {
                    throw new Error('Supabase client not available');
                }

                // Test with a simple 1x1 pixel image
                const { data, error } = await supabase.functions.invoke('chat-with-ai', {
                    body: {
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    { type: 'text', text: 'What do you see in this image?' },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=='
                                        }
                                    }
                                ]
                            }
                        ]
                    }
                });

                if (error) {
                    throw error;
                }

                document.getElementById('image-function-result').innerHTML = `
                    <div class="success">
                        ‚úÖ Image Function works!<br>
                        <strong>Response:</strong> ${data.response}<br>
                        <strong>Timestamp:</strong> ${data.timestamp}
                    </div>
                `;
            } catch (error) {
                document.getElementById('image-function-result').innerHTML = `
                    <div class="error">
                        ‚ùå Image Function failed<br>
                        <strong>Error:</strong> ${error.message}<br>
                        <strong>Details:</strong> ${JSON.stringify(error, null, 2)}
                    </div>
                `;
            }
        };

        // Initialize
        displayEnvironmentInfo();
        testSupabaseConfig();
    </script>
</body>
</html>
